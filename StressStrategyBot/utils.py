from typing import Dict, List
import time
from telegram import Message
import asyncio

def calculate_results(answers: Dict[int, int], questions: List[Dict]) -> Dict[str, float]:
    strategy_scores = {
        "–∏–∑–±–µ–≥–∞–Ω–∏–µ": [],
        "—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º": [],
        "–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–∏–µ": [],
        "—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è": [],
        "–ø–æ–∏—Å–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏": []
    }

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º
    for q in questions:
        question_id = q["id"]
        if question_id in answers:
            strategy_scores[q["strategy"]].append(answers[question_id])

    results = {}
    for strategy, scores in strategy_scores.items():
        if scores:
            max_score = len(scores) * 5  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª (5) —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
            total_score = sum(scores)
            percentage = (total_score / max_score) * 100
            results[strategy] = round(percentage, 1)
        else:
            results[strategy] = 0.0

    return results

async def show_progress_animation(message: Message) -> None:
    progress_msg = await message.reply_text("–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤... 0%")
    for i in range(1, 11):
        await asyncio.sleep(0.3)
        await progress_msg.edit_text(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤... {i*10}%")
    await progress_msg.delete()

def format_results_message(results: Dict[str, float], dominant_strategy: str, description: str, user_name: str = "–≥–æ—Å—Ç—å") -> str:
    message = f"üëã –ü—Ä–∏–≤–µ—Ç, {user_name}! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø—Ä–æ—à–µ–ª —Ç–µ—Å—Ç!\n\n"
    message += "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ó–æ—è –°–∫–æ–±–µ–ª—å—Ü—ã–Ω–∞, —è ‚Äî —Å–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ—É—á ICF, –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å, "
    message += "—ç–∫—Å–ø–µ—Ä—Ç –º–µ—Ç–æ–¥–∞ –Ω–µ–π—Ä–æ–∏–Ω—Ç–µ—Ä–∞—Ü–∏–∏ –∏ —Å–ø–∏–∫–µ—Ä TEDx. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ–±–æ –º–Ω–µ –∏ –º–æ–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö "
    message += "–º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –∑–¥–µ—Å—å: https://t.me/walktochange\n\n"
    message += "–í —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç–µ —è —á–∞—Å—Ç–æ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Å—å —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –∫–∞—Å–∞—é—Ç—Å—è –≤—Ä–µ–º–µ–Ω–∏, "
    message += "–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏.\n\n"
    message += "–¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è, –∏ —ç—Ç–æ –∑–¥–æ—Ä–æ–≤–æ! –í–æ—Ç –∫–∞–∫ –æ–Ω–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏–ª–∏—Å—å:\n\n"

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    symbols = {
        "–∏–∑–±–µ–≥–∞–Ω–∏–µ": "‚óÜ",
        "—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º": "‚òÖ",
        "–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–∏–µ": "‚öò",
        "—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è": "‚ô°",
        "–ø–æ–∏—Å–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏": "‚ö°"
    }

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
    sorted_results = sorted(results.items(), key=lambda x: x[1], reverse=True)

    for strategy, percentage in sorted_results:
        message += f"{symbols[strategy]} {strategy.title()}: {percentage}%\n"

    message += f"\n–¢—ã —á–∞—â–µ –≤—Å–µ–≥–æ –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ '{dominant_strategy}' ({results[dominant_strategy]}%). "
    message += f"–≠—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º, —á—Ç–æ –≤ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö —Ç—ã —Å–∫–ª–æ–Ω–µ–Ω {description}.\n\n"

    message += "–ü–æ–º–Ω–∏: –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç \"–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö\" –∏–ª–∏ \"–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö\" —Å—Ç—Ä–∞—Ç–µ–≥–∏–π. "
    message += "–ö–∞–∂–¥–∞—è –∏–∑ –Ω–∏—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö. "
    message += "–í–∞–∂–Ω–æ –æ—Å–æ–∑–Ω–∞–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —É–º–µ—Ç—å –∏—Ö –≥–∏–±–∫–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏.\n\n"

    message += "–Ø —Å–¥–µ–ª–∞–ª–∞ —ç—Ç–æ—Ç —Ñ–∞–π–ª, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–≤–æ–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.\n\n"

    message += "–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ –º–æ–π –±–ª–æ–≥ –≤ Instagram –∏ Telegram –∏ –¥–µ–ª–∏—Å—å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º —Å –¥—Ä—É–∑—å—è–º–∏, –æ–±–Ω–∏–º–∞—é:\n"
    message += "Telegram: @zoyaskobeltsyna\n"
    message += "Telegram-–∫–∞–Ω–∞–ª: @walktochange"

    return message